# 薬局在庫管理使用ガイド

## セットアップ

1. 新しいExcelワークブックを作成するか、既存のものを使用する
2. VBAモジュールをインポートする（Alt+F11、右クリック、ファイルのインポート...）
3. DrugNameConverterモジュールから`InitWorkbook`関数を実行して基本構造をセットアップする
4. ワークブックは必要なワークシートと書式設定で初期化されます

## 主な機能

### 医薬品名比較（Sheet1とSheet2）

1. Sheet1の列B（7行目から）に比較する医薬品名を追加する
2. Sheet2の列Bにターゲット医薬品名を追加する
3. ツール > マクロメニューから`RunDrugNameComparison`関数を実行する
4. システムは医薬品名から自動的に包装形態を抽出します
5. 結果はSheet1の列Cに表示され、マッチ率は列Dに表示されます

### 棚管理

1. tmp_tanaワークシートが存在し、棚情報が含まれていることを確認する
2. Sheet1のA4セルから始まるセルに医薬品名を追加する
3. ShelfManagerモジュールから`UpdateShelfNumbersWithShelfInfo`関数を実行する
4. 棚情報が更新され、CSVファイルが作成されます

## 棚番一括更新システムの使用方法

### 棚番一括更新処理
1. Excel VBAでマクロを有効にします
2. ツール > マクロメニューから「ShowMainMenu」を選択して実行
3. メインメニューから「棚番一括更新機能」を選択
4. 表示されるフォームで棚名1〜3を入力（最大3種類の棚名を指定可能）
5. GTIN-14コードが記載されたCSVファイルのあるフォルダを選択
6. システムは以下の処理を行います：
   - CSVファイルからGTIN-14コードを読み込み
   - 各コードに対応する医薬品名を検索
   - tmp_tanaシート内で医薬品名と部分一致する行を検索
   - 該当行の棚名列（G〜I列）を更新
   - 結果をCSVファイルとして出力

### CSVファイル形式
- 1行に1つのGTIN-14コード（14桁の数字）
- 最大3つのCSVファイルを同時処理可能
- ファイル名は任意（拡張子が.csvであること）

### 棚名を元に戻す
1. Excel VBAでマクロを有効にします
2. ツール > マクロメニューから「ShelfManager_new.UndoShelfNames」を選択して実行
3. 最後の更新処理で変更された棚名が元に戻ります

### 注意事項
- 処理対象のGTINコードが医薬品コードシートに存在しない場合は「未登録」と表示
- 医薬品名の部分一致が複数見つかった場合は、その医薬品の更新がスキップされます
- 更新結果は「update_tmp_tana_[日時].csv」として保存されます

## ヒント

- マッチしきい値はデフォルトで80%に設定されていますが、コードで変更できます
- 医薬品名は基本名、剤形タイプ、強度、メーカー、パッケージなどのコンポーネントに解析されます
- システムは様々なパッケージタイプを処理します：PTP、バラ、SP、分包、小包、調剤用、PTP(患者用)

## GTIN-14コード処理機能の使用方法

### GTIN-14コードから医薬品情報を処理する
1. Excel VBAでマクロを有効にします
2. メニューから「ツール」→「マクロ」を選択
3. マクロ一覧から「RunGS1CodeProcessing」を選択して実行
4. 表示されるダイアログにGTIN-14の14桁コードを入力
5. システムは以下の処理を行います：
   - 医薬品コードシートから医薬品名を検索
   - 医薬品名を成分や剤形などの要素に分解
   - tmp_tanaシートで対応する医薬品を検索
   - 見つかった医薬品名を設定シートのC列に転記

### GTIN-14コードの構造について
GTIN-14コードは以下の構造を持ちます：
1. **パッケージ・インジケーター（PI）** - 1桁目
   - 0：調剤包装単位
   - 1：販売包装単位
   - 2：元梱包装単位
2. **GS1事業者コード** - 2～8桁目（日本の場合、"49"で始まる）
3. **商品アイテムコード** - 9～13桁目
4. **チェックデジット** - 14桁目（誤読防止のための数値）

### 注意事項
- 本システムはGTIN-14形式（14桁）のみをサポートしています
- パッケージ・インジケーターの値によって包装単位が異なります
- 医薬品コードシートに該当するコードが存在しない場合はエラーメッセージが表示されます
