# 医薬品名変換ツール - Mac版

## 概要
このツールは医薬品コードから医薬品名を検索し、異なるマスターデータ間での薬品名変換を支援します。
医薬品の包装形態（バラ、PTP、分包など）を考慮して、最も適切な一致を見つけます。

## 検索アルゴリズム

検索は、以下の段階的なプロセスで行われます:

### 段階1: 医薬品名の完全一致検索
最初に、医薬品の基本名称（商品名）の完全一致を探します。これは最も高い優先度を持ちます。
基本名称が完全に一致する場合、その医薬品名が選択されます。

例：
- 検索: `リリカカプセル75mg`
- 完全一致: `リリカカプセル75mg`

### 段階2: 医薬品名+規格の一致検索
次に、医薬品名が完全に一致しない場合、医薬品の基本名称が類似（70%以上の類似度）していて、かつ規格（含量）が完全に一致するものを探します。

例：
- 検索: `リリカカプセル75mg`
- 一致: `リリカOD錠75mg` (基本名「リリカ」の類似度が高く、規格「75mg」が一致)

### 段階3: 包装形態を考慮した類似度検索
前の2段階で一致するものが見つからない場合、包装形態（PTP、バラなど）も考慮した総合的な類似度検索を実行します。
この段階では、以下の要素に基づいてスコアを計算します:

1. 基本名称の類似度 (60%)
2. 剤形の一致 (15%)
3. 規格の一致 (15%)
4. メーカーの一致 (5%)
5. 包装形態の一致 (5%)

閾値以上のスコアを持つ医薬品名が最終的な一致として選択されます。

### 包装形態の考慮

包装形態は以下のように検出・考慮されます:

- **バラ包装**: 「バラ」「調剤用」などのキーワードを含む
- **PTP包装**: 「PTP」「シート」などのキーワードを含む
- **分包**: 「分包」「分包紙」「粉末分包」などのキーワードを含む
- **その他**: SP、包装小、瓶、アンプルなど

## 処理フロー

1. 医薬品コードから医薬品名を取得
2. 包装形態の自動判定または選択
3. 上記の段階的なアルゴリズムで検索
4. マッチした結果を設定シートに記録

## 使用方法

1. 設定シートに医薬品コードを入力（A7セルから下）
2. 包装形態を選択（B4セル）またはツールに自動判定させる
3. マクロを実行（`ProcessDrugCodesAndCompare`関数）
4. 処理終了後に結果を確認

## 主な機能

- 医薬品コードから医薬品名を自動検索
- 包装形態（バラ包装、分包品）に基づいた医薬品名の最適化
- 最初の医薬品名から自動的に包装形態を判定し、処理を最適化
- 進捗状況のリアルタイム表示（ステータスバー使用）
- 強化されたエラーハンドリングによる安定動作

## 動作環境

- macOS 10.13以降
- Excel for Mac 2016以降
- VBAマクロが有効化されていること

## インストール方法

1. このリポジトリをダウンロードまたはクローンします
2. `Mac_DrugNameConverter.xlsm`ファイルをお好みの場所に保存します
3. マクロを有効にしてファイルを開きます

## ファイル構成

- `Mac_DrugNameConverter.xlsm`: メインのExcelファイル
- `src/`: VBAソースコード
  - `DrugNameConverter_Mac.bas`: メイン処理モジュール（Mac用）
  - `DrugNameParser_Mac.bas`: 医薬品名解析モジュール
  - `MainModule_Mac.bas`: ユーティリティ関数モジュール

## 医薬品マスターシートについて

医薬品マスターシートは以下の形式で作成してください：

- シート名: 「薬品マスター」
- A列: 医薬品コード（14桁）
- B列: 医薬品名

## 包装形態について

ツールは以下の包装形態を認識します：

- バラ包装: 「バラ」、「調剤用」などの表記
- 分包品: 「PTP」、「分包」、「SP」、「包装小」、「PTP(患者用)」などの表記

## 自動処理の最適化

ツールは最初の医薬品から包装形態を自動判定し、処理を最適化します。これにより、ユーザーは包装形態を明示的に選択する必要がなく、大量のデータを効率的に処理できます。

## トラブルシューティング

- マクロが実行できない場合は、Excelのセキュリティ設定でマクロを有効にしてください。
- エラーが発生した場合は、詳細なエラーメッセージが表示されます。
- 「[マスターシートなし]」と表示された場合は、「薬品マスター」シートが存在するか確認してください。
- 「[コード未登録]」と表示された場合は、該当する医薬品コードが医薬品マスターシートに登録されていません。

## ライセンス

このツールはMITライセンスの下で公開されています。詳細はLICENSEファイルを参照してください。 